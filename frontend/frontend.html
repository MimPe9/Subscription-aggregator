<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscriptions</title>
    <style>
        body { font-family: Arial; max-width: 400px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        .delete-btn { background: #dc3545; }
        .sum-btn { background: #28a745; }
        .message { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .result { margin: 10px 0; padding: 15px; background: #e9ecef; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Добавить подписку</h1>
    <form id="subscriptionForm">
        <input type="text" id="serviceName" required placeholder="Сервис">
        <input type="number" id="price" required placeholder="Цена">
        <input type="text" id="userId" required placeholder="User ID (UUID)">
        <input type="text" id="startDate" required placeholder="Начало ММ-ГГГГ">
        <input type="text" id="endDate" placeholder="Конец ММ-ГГГГ (необязательно)">
        <button type="submit">Добавить</button>
    </form>

    <div id="message"></div>

    <h2>Удалить подписку</h2>
    <form id="deleteForm">
        <input type="text" id="deleteId" required placeholder="ID подписки">
        <button type="submit" class="delete-btn">Удалить</button>
    </form>

    <h2>Подсчитать сумму</h2>
    <form id="sumForm">
        <input type="text" id="sumUserId" placeholder="User ID (необязательно)">
        <input type="text" id="sumServiceName" placeholder="Сервис (необязательно)">
        <input type="text" id="sumStartDate" placeholder="Начало периода ММ-ГГГГ">
        <input type="text" id="sumEndDate" placeholder="Конец периода ММ-ГГГГ">
        <button type="submit" class="sum-btn">Посчитать сумму</button>
    </form>
    
    <div id="sumResult"></div>

    <script>
        document.getElementById('subscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                service_name: document.getElementById('serviceName').value,
                price: parseInt(document.getElementById('price').value),
                user_id: document.getElementById('userId').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value
            };

            try {
                const response = await fetch('http://localhost:8010/api/subscriptions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Подписка добавлена! ID: ' + result.id, 'success');
                    document.getElementById('subscriptionForm').reset();
                } else {
                    showMessage('Ошибка: ' + (result.error || 'Ошибка сервера'), 'error');
                }
            } catch (error) {
                showMessage('Ошибка подключения', 'error');
            }
        });

        document.getElementById('deleteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const deleteId = document.getElementById('deleteId').value;
            try {
                const response = await fetch(`http://localhost:8010/api/subscriptions/del/${deleteId}`, {method: 'DELETE'});
                const result = await response.json();
                if (response.ok) {
                    showMessage('Подписка удалена!', 'success');
                    document.getElementById('deleteForm').reset();
                } else {
                    showMessage('Ошибка: ' + (result.error || 'Ошибка сервера'), 'error');
                }
            } catch (error) {
                showMessage('Ошибка подключения', 'error');
            }
        });

        document.getElementById('sumForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = {
                user_id: document.getElementById('sumUserId').value,
                service_name: document.getElementById('sumServiceName').value,
                start_date: document.getElementById('sumStartDate').value,
                end_date: document.getElementById('sumEndDate').value
            };
            try {
                const response = await fetch('http://localhost:8010/api/subscriptions/sum', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (response.ok) {
                    document.getElementById('sumResult').innerHTML = `<div class="result">Сумма: ${result.total_price} руб.</div>`;
                } else {
                    showMessage('Ошибка: ' + (result.error || 'Ошибка сервера'), 'error');
                }
            } catch (error) {
                showMessage('Ошибка подключения', 'error');
            }
        });

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
        }
    </script>
</body>
</html>